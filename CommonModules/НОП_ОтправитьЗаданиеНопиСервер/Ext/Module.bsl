#Область СлужебныйПрограммныйИнтерфейс

// Процедура для формирования XML-файла
// Параметры:
//  ТекстСообщения - Строка, сообщение для отправки
//  ХешКлиента - Строка, хеш клиента
//  ИмяФайлаЗапроса - Строка, имя файла для сохранения XML
//  Ссылка - УникальныйИдентификатор, GUID для запроса
Процедура ФормироватьXML(ТекстСообщения, ХешКлиента, ИмяФайлаЗапроса, Ссылка) Экспорт
	// Инициализируем объект для записи XML
	ХешКлиентаАтрибут = XMLСтрока(ХешКлиента);
	
	// Создаем объект для записи XML
	ОбъектЗапись = Новый ЗаписьXML;
	ПараметрыЗаписиXML = Новый ПараметрыЗаписиXML("utf-8", , Ложь);
	
	Попытка
		ОбъектЗапись.ОткрытьФайл(ИмяФайлаЗапроса, ПараметрыЗаписиXML);
		ОбъектЗапись.ЗаписатьОбъявлениеXML();
		
		// Записываем корневой элемент Request
		ОбъектЗапись.ЗаписатьНачалоЭлемента("Request");
		ОбъектЗапись.ЗаписатьАтрибут("GUID", Строка(Ссылка));
		
		// Записываем элемент ClientInfo
		ОбъектЗапись.ЗаписатьНачалоЭлемента("ClientInfo");
		ОбъектЗапись.ЗаписатьНачалоЭлемента("token");
		ОбъектЗапись.ЗаписатьАтрибут("token", ХешКлиентаАтрибут);
		ОбъектЗапись.ЗаписатьАтрибут("message", ТекстСообщения);
		ОбъектЗапись.ЗаписатьКонецЭлемента(); // Закрываем элемент token
		ОбъектЗапись.ЗаписатьКонецЭлемента(); // Закрываем элемент ClientInfo
		
		// Закрываем корневой элемент Request
		ОбъектЗапись.ЗаписатьКонецЭлемента(); // Закрываем элемент Request
		
		ОбъектЗапись.Закрыть(); // Закрываем файл
		
	Исключение
		Сообщить("Ошибка при записи XML: " + ОписаниеОшибки());
		Возврат; // Завершаем выполнение процедуры в случае ошибки
	КонецПопытки;
КонецПроцедуры

//Функция ПолучитьURLПараметры(URLСтрока)
//	МассивПараметровURL = Новый Структура;
//	
//	Возврат МассивПараметровURL;
//КонецФункции	

Функция ПолучитьURLПараметры(URLСтрока) Экспорт
	// Создаем структуру для хранения параметров URL
	МассивПараметровURL = Новый Структура;
	
	// Находим протокол
	Протокол = "";
	Если Найти(URLСтрока, "://") > 0 Тогда
		Протокол = Лев(URLСтрока, Найти(URLСтрока, "://") - 1);
		URLСтрока = Сред(URLСтрока, Найти(URLСтрока, "://") + 3); // Убираем протокол
	КонецЕсли;
	
	// Находим хост и порт
	Хост = "";
	Порт = "";
	Если Найти(URLСтрока, "/") > 0 Тогда
		// Извлекаем хост и порт до первого слэша
		ХостИПорт = Лев(URLСтрока, Найти(URLСтрока, "/") - 1);
		URLСтрока = Сред(URLСтрока, Найти(URLСтрока, "/")); // Убираем хост и порт
	Иначе
		ХостИПорт = URLСтрока; // Если слэш не найден, это весь URL
		URLСтрока = ""; // Очищаем строку
	КонецЕсли;
	
	// Проверяем, есть ли порт
	Если Найти(ХостИПорт, ":") > 0 Тогда
		Хост = Лев(ХостИПорт, Найти(ХостИПорт, ":") - 1);
		Порт = Сред(ХостИПорт, Найти(ХостИПорт, ":") + 1);
	Иначе
		Хост = ХостИПорт; // Если порта нет, сохраняем хост
	КонецЕсли;
	
	// Сохраняем параметры в структуру
	МассивПараметровURL.Вставить("Протокол", Протокол);
	МассивПараметровURL.Вставить("Хост", Хост);
	МассивПараметровURL.Вставить("Порт", Порт);
	МассивПараметровURL.Вставить("Ресурс", URLСтрока);
	
	// Возвращаем структуру с параметрами URL
	Возврат МассивПараметровURL;
КонецФункции


// Функция для отправки запроса на сервер
// Параметры:
//  ИмяФайлаЗапроса - Строка, имя файла запроса
// Возвращает время регистрации обращения или Неопределено в случае ошибки
Функция ОтправитьНаСервер(ИмяФайлаЗапроса) Экспорт
	Попытка
		Если НЕ ПустаяСтрока(Константы.НОП_АдресСервисаНОПи.Получить()) Тогда
			АдресСервисаСтрока = Константы.НОП_АдресСервисаНОПи.Получить();
			ПараметрыURL = ПолучитьURLПараметры(АдресСервисаСтрока);
			АдресСервиса = ПараметрыURL.Хост;
			Попытка
				Порт = Число(ПараметрыURL.Порт);
			Исключение       
				Порт = 80;
			КонецПопытки;
			РесурсВСервисе = ПараметрыURL.Ресурс;//"/message";
			
			// Устанавливаем соединение с сервером
			//Попытка
			Соединение = Новый HTTPСоединение(АдресСервиса, Порт, , ,);
		Иначе         
			Константы.НОП_АдресСервисаНОПи.Установить("http://nopi.pro:20354/message");
			Константы.НОП_АдресСервисаНОПи.Записать();
			ОтправитьНаСервер(ИмяФайлаЗапроса);
		КонецЕсли;
	Исключение
		Сообщить("Не удалось установить соединение с сервером НОПи: " + ИнформацияОбОшибке().Описание, СтатусСообщения.Важное);
		Возврат Неопределено; // Возвращаем Неопределено в случае ошибки
	КонецПопытки;
	
	// Отправляем HTTP-запрос
	Попытка
		HTTPЗапрос = Новый HTTPЗапрос(РесурсВСервисе);
		HTTPЗапрос.УстановитьИмяФайлаТела(ИмяФайлаЗапроса);
		
		Результат = Соединение.ОтправитьДляОбработки(HTTPЗапрос);
		Соединение = Неопределено; // Освобождаем соединение
		
		Если Результат.КодСостояния > 299 Тогда
			Сообщить("Код ответа " + Результат.КодСостояния + ". Сообщение не принято");
			Возврат Неопределено; // Возвращаем Неопределено в случае ошибки
		КонецЕсли;
		
		Возврат Результат.Заголовки["Date"]; // Возвращаем время регистрации обращения
	Исключение
		Сообщить("Ошибка при отправке запроса: " + ИнформацияОбОшибке().Описание, СтатусСообщения.Важное);
		Возврат Неопределено; // Возвращаем Неопределено в случае ошибки
	КонецПопытки;
КонецФункции

// Процедура для сохранения сообщения в регистр
// Параметры:
//  Date - Дата, время обращения
//  ТекстОбращения - Строка, текст сообщения
//  Токен - Строка, токен клиента
//  GUID - УникальныйИдентификатор, GUID запроса
Процедура СохранитьСообщение(Date, ТекстОбращения, Токен, GUID) Экспорт
	// Создание менеджера записи для регистра сведений "УчетСообщений"
	МенеджерЗаписи = РегистрыСведений.НОП_ИсторияВзаимодействияНопик.СоздатьМенеджерЗаписи();
	
	// Добавление сообщения в регистр сведений
	МенеджерЗаписи.Поле_0 = НОП_ГлобальныйПоискВызовСервера.ТекущаяДатаСервера(); // Текущая дата сервера
	МенеджерЗаписи.Поле_1 = Date; // Дата обращения
	МенеджерЗаписи.Поле_2 = ТекстОбращения; // Текст сообщения
	МенеджерЗаписи.Поле_3 = XMLСтрока(Токен); // Локальный токен для регистра сведений
	МенеджерЗаписи.Поле_4 = GUID; // GUID запроса
	
	МенеджерЗаписи.Записать(); // Записываем данные в регистр
КонецПроцедуры

// Процедура для отправки сообщения на сервер НОПи
// Параметры:
//  ТекстСообщения - Строка, сообщение для отправки
//  ХешКлиента - Строка, хеш клиента
Процедура ОтправитьСообщениеНопику(ТекстСообщения, ХешКлиента) Экспорт
	// Получаем объект константы по имени
	АдресСервисаКонстанта = Константы.НОП_АдресСервисаНОПи.Получить();
	
	// Проверяем, что константа найдена
	Если ПустаяСтрока(АдресСервисаКонстанта) Тогда
		// Устанавливаем новое значение
		Константы.НОП_АдресСервисаНОПи.Установить("http://nopi.pro:20354/message");
		// Сохраняем изменения
		//Константы.НОП_АдресСервисаНОПи.Записать();
	КонецЕсли;
	
	ИмяФайлаЗапроса = ПолучитьИмяВременногоФайла(); // Получаем имя временного файла
	Ссылка = Новый УникальныйИдентификатор; // Генерируем новый GUID
	
	// Формируем XML
	ФормироватьXML(ТекстСообщения, ХешКлиента, ИмяФайлаЗапроса, Ссылка);
	
	// Отправляем на сервер и получаем время регистрации
	ВремяРегистрацииОбращения = ОтправитьНаСервер(ИмяФайлаЗапроса);
	
	// Если отправка прошла успешно, показываем сообщение пользователю и сохраняем в регистр
	Если ВремяРегистрацииОбращения <> Неопределено Тогда
		СообщениеИдентификацииЗапроса = "Запрос принят. Время НОПи: " + ВремяРегистрацииОбращения;
		НОП_ГлобальныйПоискКлиентСервер.ПоказатьСообщениеПользователю(СообщениеИдентификацииЗапроса);
		
		// Сохраняем сообщение в регистр
		СохранитьСообщение(ВремяРегистрацииОбращения, ТекстСообщения, ХешКлиента, Ссылка);
	КонецЕсли;
КонецПроцедуры

#КонецОбласти
